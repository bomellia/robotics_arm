<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Reader</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #ffffff;
            color: #000000;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #000000;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .config-panel {
            background: #f5f5f5;
            border: 1px solid #d0d0d0;
            padding: 15px;
            margin-bottom: 20px;
        }

        .config-row {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            align-items: center;
        }

        .config-row:last-child {
            margin-bottom: 0;
        }

        label {
            font-size: 14px;
            min-width: 120px;
            font-weight: 500;
        }

        input {
            padding: 6px 10px;
            border: 1px solid #d0d0d0;
            background: #ffffff;
            font-size: 14px;
            font-family: monospace;
        }

        input:focus {
            outline: 2px solid #000000;
            outline-offset: 0;
        }

        button {
            padding: 8px 16px;
            background: #000000;
            color: #ffffff;
            border: none;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
        }

        button:hover {
            background: #333333;
        }

        button:active {
            background: #555555;
        }

        .video-container {
            background: #f5f5f5;
            border: 1px solid #d0d0d0;
            padding: 15px;
            margin-bottom: 20px;
        }

        #videoFeed {
            width: 100%;
            max-width: 800px;
            height: auto;
            display: block;
            border: 1px solid #d0d0d0;
        }

        #cameraView {
            width: 100%;
            max-width: 800px;
            height: auto;
            display: block;
            border: 1px solid #d0d0d0;
            background: #000000;
        }

        .camera-controls {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .status {
            font-size: 12px;
            padding: 5px 10px;
            background: #f5f5f5;
            border: 1px solid #d0d0d0;
            margin-top: 10px;
            font-family: monospace;
        }

        .status.success {
            background: #e8f5e9;
            border-color: #81c784;
        }

        .status.error {
            background: #ffebee;
            border-color: #e57373;
        }

        .info {
            font-size: 12px;
            color: #666666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Card Reader</h1>

        <div class="section">
            <div class="section-title">Configuration</div>
            <div class="config-panel">
                <div class="config-row">
                    <label>Number of Cards:</label>
                    <input type="number" id="numCards" value="5" min="1" max="10">
                </div>
                <div class="config-row">
                    <label>Confidence:</label>
                    <input type="number" id="confidence" value="0.5" min="0" max="1" step="0.1">
                    <span class="info">Detection threshold (0.0-1.0)</span>
                </div>
                <div class="config-row">
                    <button onclick="saveConfig()">Save Configuration</button>
                </div>
                <div id="configStatus" class="status" style="display: none;"></div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">Camera with Zone Lines</div>
            <div class="video-container">
                <div style="position: relative; display: inline-block;">
                    <video id="cameraView" autoplay playsinline></video>
                    <div id="zoneOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></div>
                </div>
                <div class="camera-controls">
                    <button onclick="startCamera()">Start Camera</button>
                    <button onclick="stopCamera()">Stop Camera</button>
                </div>
                <div id="cameraStatus" class="status" style="display: none;"></div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">Detection Results</div>
            <div class="config-panel">
                <div id="detectionResults" style="font-family: monospace; font-size: 14px; line-height: 1.8;">
                    Waiting for camera...
                </div>
            </div>
        </div>
    </div>

    <script>
        let videoStream = null;
        let captureInterval = null;

        // Load configuration on page load
        window.onload = function() {
            loadConfig();
        };

        function loadConfig() {
            fetch('/config')
                .then(response => response.json())
                .then(config => {
                    document.getElementById('numCards').value = config.detection.num_cards;
                    document.getElementById('confidence').value = config.detection.confidence_threshold;
                })
                .catch(error => {
                    console.error('Error loading config:', error);
                });
        }

        function saveConfig() {
            const config = {
                detection: {
                    num_cards: parseInt(document.getElementById('numCards').value),
                    confidence_threshold: parseFloat(document.getElementById('confidence').value)
                }
            };

            fetch('/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                showStatus('configStatus', 'Configuration saved successfully', 'success');
                // Redraw zone lines if camera is active
                if (videoStream) {
                    drawZoneLines();
                }
            })
            .catch(error => {
                showStatus('configStatus', 'Error saving configuration', 'error');
                console.error('Error:', error);
            });
        }

        function drawZoneLines() {
            const video = document.getElementById('cameraView');
            const overlay = document.getElementById('zoneOverlay');
            const numZones = parseInt(document.getElementById('numCards').value);

            // Clear previous lines
            overlay.innerHTML = '';

            // Wait for video to be ready
            if (video.videoWidth === 0) {
                setTimeout(drawZoneLines, 100);
                return;
            }

            // Draw vertical lines to divide zones
            for (let i = 1; i < numZones; i++) {
                const line = document.createElement('div');
                const leftPercent = (i / numZones) * 100;
                line.style.position = 'absolute';
                line.style.left = leftPercent + '%';
                line.style.top = '0';
                line.style.width = '3px';
                line.style.height = '100%';
                line.style.backgroundColor = 'yellow';
                line.style.boxShadow = '0 0 5px black';
                overlay.appendChild(line);
            }

            // Draw zone labels
            for (let i = 0; i < numZones; i++) {
                const label = document.createElement('div');
                const centerPercent = ((i + 0.5) / numZones) * 100;
                label.style.position = 'absolute';
                label.style.left = centerPercent + '%';
                label.style.top = '10px';
                label.style.transform = 'translateX(-50%)';
                label.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                label.style.color = 'yellow';
                label.style.padding = '5px 10px';
                label.style.borderRadius = '3px';
                label.style.fontSize = '14px';
                label.style.fontWeight = 'bold';
                label.textContent = 'Zone ' + (i + 1);
                overlay.appendChild(label);
            }
        }

        function startCamera() {
            navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            })
            .then(stream => {
                videoStream = stream;
                document.getElementById('cameraView').srcObject = stream;
                showStatus('cameraStatus', 'Camera started', 'success');

                // Draw zone lines once video is loaded
                const video = document.getElementById('cameraView');
                video.onloadedmetadata = function() {
                    drawZoneLines();
                };

                // Start capturing frames every 1 second
                captureInterval = setInterval(captureFrame, 1000);
            })
            .catch(error => {
                showStatus('cameraStatus', 'Error accessing camera: ' + error.message, 'error');
                console.error('Error accessing camera:', error);
            });
        }

        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                document.getElementById('cameraView').srcObject = null;
                videoStream = null;
                showStatus('cameraStatus', 'Camera stopped', 'success');
            }

            if (captureInterval) {
                clearInterval(captureInterval);
                captureInterval = null;
            }

            // Clear overlay and results
            document.getElementById('zoneOverlay').innerHTML = '';
            document.getElementById('detectionResults').innerHTML = 'Camera stopped.';
        }

        function captureFrame() {
            if (!videoStream) return;

            const video = document.getElementById('cameraView');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            canvas.toBlob(blob => {
                const formData = new FormData();
                formData.append('frame', blob, 'frame.jpg');

                fetch('/upload_frame', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Display results as text
                        displayResults(data.results, data.card_presence, data.hand);
                    } else {
                        console.error('Error processing frame:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error uploading frame:', error);
                });
            }, 'image/jpeg', 0.8);
        }

        function displayResults(results, cardPresence, hand) {
            const resultsDiv = document.getElementById('detectionResults');
            let html = '<strong>Card Detection Status:</strong><br><br>';

            results.forEach((result, index) => {
                const zoneNum = result.zone + 1;
                const status = result.has_card ? '✓ CARD' : '✗ EMPTY';
                const color = result.has_card ? '#00c800' : '#999999';
                const cardsStr = result.cards_str && result.cards_str.length > 0 ? result.cards_str.join(', ') : '-';

                html += `<div style="margin-bottom: 8px; padding: 6px; background: ${result.has_card ? '#f0fff0' : '#f8f8f8'}; border-left: 4px solid ${color};">`;
                html += `<strong>Zone ${zoneNum}:</strong> <span style="color: ${color};">${status}</span> ${cardsStr}`;
                html += `</div>`;
            });

            // Hand list with None for empty slots
            const handStr = '[' + hand.map(c => c ? `(${c[0]}, '${c[1]}')` : 'None').join(', ') + ']';
            html += `<br><strong>Hand:</strong><br><code style="background: #f0f0f0; padding: 8px; display: block; margin-top: 5px;">${handStr}</code>`;

            resultsDiv.innerHTML = html;
        }

        function showStatus(elementId, message, type) {
            const statusEl = document.getElementById(elementId);
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
            statusEl.style.display = 'block';

            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>
